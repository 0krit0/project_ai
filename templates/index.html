<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CarDamage AI</title>
<link rel="stylesheet" href="/static/ui.css">
</head>
<body>
{% if not session.get("user") %}
  <main class="auth-wrap">
    <section class="auth-card">
      <h1 class="auth-title">CarDamage AI</h1>
      <p class="auth-sub">ระบบประเมินความเสียหายรถยนต์ด้วย AI</p>
      <a href="/login"><button class="btn" type="button" style="width:100%">เข้าสู่ระบบ</button></a>
    </section>
  </main>
{% else %}
  <div class="page">
    <aside class="sidebar">
      <div class="brand">CarDamage AI</div>
      <div class="tagline">เครื่องมือประเมินความเสียหายเบื้องต้น</div>
      <div class="tagline">ผู้ใช้: {{ session.user.name }}</div>
      <nav class="nav">
        <a href="/">วิเคราะห์</a>
        <a href="/history">ประวัติ</a>
        <a href="/profile">โปรไฟล์</a>
        <a href="/export_csv">ส่งออก CSV</a>
        <a href="/logout">ออกจากระบบ</a>
      </nav>
    </aside>

    <main class="main">
      <header class="header">
        <h1>วิเคราะห์ความเสียหายรถยนต์</h1>
        <p>อัปโหลดภาพ 1 รูป เลือกตำแหน่งความเสียหาย และตรวจผลลัพธ์ AI พร้อมคำแนะนำซ่อมเบื้องต้น</p>
      </header>

      <section class="grid">
        <article class="card">
          <h3>เริ่มวิเคราะห์</h3>
          <form method="post" enctype="multipart/form-data" id="analyzeForm">
            <label for="part">ตำแหน่งความเสียหาย</label>
            <select id="part" name="part" required>
              <option value="กันชนหน้า">กันชนหน้า</option>
              <option value="กันชนหลัง">กันชนหลัง</option>
              <option value="ประตู">ประตู</option>
              <option value="ฝากระโปรงหน้า">ฝากระโปรงหน้า</option>
              <option value="แก้มข้างรถ">แก้มข้างรถ</option>
              <option value="ไฟหน้า">ไฟหน้า</option>
              <option value="กระจกรถ">กระจกรถ</option>
            </select>

            <label for="file">รูปความเสียหาย</label>
            <input id="file" type="file" name="file" accept="image/*" required>
            <p class="helper">แนะนำภาพที่เห็นจุดเสียหายชัดเจน ไม่เบลอ และไม่มืดเกินไป</p>

            <button class="btn" type="submit" id="analyzeBtn">วิเคราะห์ทันที</button>
          </form>
        </article>

        {% if warning %}
        <article class="card">
          <div class="notice error">{{ warning }}</div>
        </article>
        {% endif %}

        {% if result %}
        <article class="card">
          <h3>ผลการประเมิน</h3>
          <div class="kpis">
            <div class="kpi">
              <div class="label">ระดับความเสียหาย</div>
              <div class="value"><span class="badge {{ result }}">{{ result }}</span></div>
            </div>
            <div class="kpi">
              <div class="label">ความมั่นใจของโมเดล</div>
              <div class="value">{{ confidence }}%</div>
            </div>
            <div class="kpi">
              <div class="label">ระดับความเชื่อมั่น</div>
              <div class="value">{{ trust }}</div>
            </div>
          </div>

          <p style="margin-top:14px"><b>คำแนะนำหลัก:</b> {{ decision }}</p>
          <ul>
            <li>{{ detail.description }}</li>
            <li>{{ detail.repair }}</li>
          </ul>

          <hr style="border:none;border-top:1px solid var(--line);margin:16px 0">

          <h3>Feedback ผลลัพธ์</h3>
          <form method="post" action="/feedback" id="feedbackForm">
            <input type="hidden" name="image_path" value="{{ image_path }}">
            <input type="hidden" name="result" value="{{ result }}">
            <input type="hidden" name="confidence" value="{{ confidence }}">

            <label>
              <input type="radio" name="is_correct" value="yes" required> ผลลัพธ์ถูกต้อง
            </label>
            <label>
              <input type="radio" name="is_correct" value="no"> ผลลัพธ์ยังไม่ถูกต้อง
            </label>

            <label for="comment">ข้อเสนอแนะเพิ่มเติม</label>
            <textarea id="comment" name="comment" placeholder="ระบุสิ่งที่ควรปรับปรุง เช่น ระดับความเสียหายควรเป็น medium"></textarea>
            <button class="btn secondary" type="submit">ส่ง Feedback</button>
          </form>
        </article>
        {% endif %}
      </section>
    </main>
  </div>
{% endif %}

<script>
(function () {
  const analyzeForm = document.getElementById('analyzeForm');
  const analyzeBtn = document.getElementById('analyzeBtn');

  if (analyzeForm && analyzeBtn) {
    analyzeForm.addEventListener('submit', function () {
      analyzeBtn.disabled = true;
      analyzeBtn.textContent = 'กำลังวิเคราะห์...';
    });
  }
})();
</script>
</body>
</html>
