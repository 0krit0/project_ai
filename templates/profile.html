<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>โปรไฟล์ | AutoScope AI</title>
<link rel="stylesheet" href="/static/ui.css">
</head>
<body>
<div class="page">
  <aside class="sidebar">
    <div class="brand">AutoScope AI</div>
    <div class="tagline">บัญชีผู้ใช้งาน</div>
    <div class="sidebar-profile">
      {% if session.get("user") and session.user.avatar_path %}
      <img class="sidebar-avatar" src="/{{ session.user.avatar_path }}" alt="profile avatar">
      {% else %}
      <div class="sidebar-avatar sidebar-avatar-fallback">{{ username[0]|upper }}</div>
      {% endif %}
      <div class="tagline">ผู้ใช้: <span class="mono">{{ username }}</span></div>
    </div>
    <nav class="nav">
      <a href="/">วิเคราะห์</a>
      <a href="/cases">เคสงาน</a>
      {% if nav_is_reviewer %}
      <a href="/reviewer">รีวิวเคส</a>
      {% endif %}
      <a href="/report/latest">รายงานล่าสุด</a>
      <a href="/history">ประวัติ</a>
      <a href="/profile">โปรไฟล์</a>
      {% if is_admin %}
      <a href="/admin">แอดมิน</a>
      {% endif %}
      <a href="/export_csv">ส่งออก CSV</a>
      <a href="/logout">ออกจากระบบ</a>
    </nav>
  </aside>

  <main class="main">
    <header class="header">
      <h1>โปรไฟล์ผู้ใช้</h1>
      <p>ภาพรวมการใช้งาน คุณภาพผลวิเคราะห์ และประวัติล่าสุดของบัญชีนี้</p>
    </header>
    {% if toast %}
    <div class="toast {{ toast.level }}">{{ toast.text }}</div>
    {% endif %}

    <section class="card soft profile-hero">
      <div>
        {% if avatar_warning %}
        <div class="notice error" style="margin-bottom:10px">{{ avatar_warning }}</div>
        {% endif %}
        {% if email_warning %}
        <div class="notice error" style="margin-bottom:10px">{{ email_warning }}</div>
        {% endif %}
        {% if email_success %}
        <div class="notice ok" style="margin-bottom:10px">{{ email_success }}</div>
        {% endif %}
        <div class="label">บัญชีผู้ใช้งาน</div>
        <div class="value mono profile-name">{{ username }}</div>
        <p class="helper">
          อีเมล: <span class="mono">{{ profile_data.email or '-' }}</span> |
          อายุ: <span class="mono">{{ profile_data.age or '-' }}</span> |
          เพศ: <span class="mono">{{ profile_data.gender or '-' }}</span>
        </p>
        <p class="helper">
          สถานะอีเมล:
          {% if profile_data.email_verified %}
          <b style="color:#1f8f4f">ยืนยันแล้ว</b>
          {% else %}
          <b style="color:#b45309">ยังไม่ยืนยัน</b>
          {% endif %}
          |
          ส่งเมลล่าสุด:
          <span class="mono">{{ (last_email_log.created_at if last_email_log else '-') }}</span>
        </p>
        <p class="helper">สถิตินี้ช่วยดูพฤติกรรมการใช้งานและความสม่ำเสมอของข้อมูลภาพที่อัปโหลด</p>
      </div>
      <div class="profile-actions">
        <a class="btn primary" href="/export_csv">ดาวน์โหลดประวัติเป็น CSV</a>
        <a class="btn ghost" href="/history">ดูประวัติทั้งหมด</a>
      </div>
    </section>

    <section class="card">
      <h3>ยืนยันอีเมล</h3>
      {% if profile_data.email_verified %}
      <div class="notice ok">อีเมลของคุณยืนยันแล้ว</div>
      {% else %}
      <p class="helper">กรุณาตรวจสอบอีเมลของคุณและกรอกรหัส 6 หลักที่ได้รับ เพื่อยืนยันบัญชีให้สมบูรณ์</p>
      <form method="post" action="/profile/email-verify/send">
        <div class="inline-actions">
          <button class="btn warm" type="submit">ส่งรหัสยืนยันเข้าอีเมล</button>
        </div>
      </form>
      <form method="post" action="/profile/email-verify/confirm" style="margin-top:10px">
        <label for="verify_code">กรอกรหัสยืนยัน 6 หลัก</label>
        <input id="verify_code" type="text" name="verify_code" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" required>
        <div class="inline-actions" style="margin-top:8px">
          <button class="btn primary" type="submit">ยืนยันอีเมล</button>
        </div>
      </form>
      {% endif %}
    </section>

    <section class="card">
      <h3>ส่งข้อมูลเข้าอีเมล</h3>
      <form method="post" action="/profile/email-summary">
        <div class="result-grid">
          <div>
            <label for="summary_scope">รูปแบบข้อมูล</label>
            <select id="summary_scope" name="summary_scope" required>
              <option value="latest" {% if email_form.scope == "latest" %}selected{% endif %}>สรุปล่าสุด (ธรรมดา)</option>
              <option value="case" {% if email_form.scope == "case" %}selected{% endif %}>สรุปตามเคส</option>
            </select>
          </div>
          <div>
            <label for="summary_tone">โหมดสรุป</label>
            <select id="summary_tone" name="summary_tone" required>
              <option value="customer" {% if email_form.tone == "customer" %}selected{% endif %}>แบบทั่วไป</option>
              <option value="technical" {% if email_form.tone == "technical" %}selected{% endif %}>แบบช่าง</option>
              <option value="insurance" {% if email_form.tone == "insurance" %}selected{% endif %}>แบบประกัน</option>
            </select>
          </div>
        </div>
        <div id="casePickerWrap">
          <label for="case_id">เลือกเคส (ใช้เมื่อเลือกสรุปตามเคส)</label>
          <select id="case_id" name="case_id">
            <option value="">-- เลือกเคส --</option>
            {% for c in user_cases %}
            <option value="{{ c.id }}" {% if (email_form.case_id|string) == (c.id|string) %}selected{% endif %}>
              #{{ c.id|case_code }} | {{ c.title }} | {{ c.status }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="inline-actions" style="margin-top:10px">
          <button class="btn ghost" type="submit">ส่งเข้าอีเมลตามโหมดที่เลือก</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h3>แก้ไขข้อมูลส่วนตัว</h3>
      <form method="post" action="/profile/update">
        <label for="profile_email">อีเมล *</label>
        <input id="profile_email" type="email" name="email" value="{{ profile_data.email or '' }}" required>
        <div class="result-grid">
          <div>
            <label for="profile_age">อายุ *</label>
            <input id="profile_age" type="number" name="age" min="10" max="120" value="{{ profile_data.age or '' }}" required>
          </div>
          <div>
            <label for="profile_gender">เพศ *</label>
            <select id="profile_gender" name="gender" required>
              <option value="male" {% if profile_data.gender == "male" %}selected{% endif %}>ชาย</option>
              <option value="female" {% if profile_data.gender == "female" %}selected{% endif %}>หญิง</option>
              <option value="other" {% if profile_data.gender == "other" %}selected{% endif %}>อื่นๆ</option>
            </select>
          </div>
        </div>
        <div class="inline-actions" style="margin-top:10px">
          <button class="btn primary" type="submit">บันทึกข้อมูล</button>
        </div>
      </form>
    </section>

    <section class="card" id="emailLogSection">
      <h3>ประวัติการส่งอีเมลล่าสุด</h3>
      {% if email_logs %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>เวลา</th>
              <th>ถึง</th>
              <th>หัวข้อ</th>
              <th>สถานะ</th>
              <th>หมายเหตุ</th>
            </tr>
          </thead>
          <tbody>
            {% for log in email_logs %}
            <tr>
              <td data-label="เวลา">{{ log.created_at }}</td>
              <td data-label="ถึง">{{ log.to_email }}</td>
              <td data-label="หัวข้อ">{{ log.subject }}</td>
              <td data-label="สถานะ">{{ log.status }}</td>
              <td data-label="หมายเหตุ">{{ log.error_text or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="notice empty">ยังไม่มีประวัติการส่งอีเมล</div>
      {% endif %}
    </section>

    <section class="card">
      <h3>รูปโปรไฟล์</h3>
      <form method="post" action="/profile/avatar" enctype="multipart/form-data">
        <div class="auth-avatar-block" style="margin-bottom:8px">
          {% if session.get("user") and session.user.avatar_path %}
          <img id="profileAvatarPreview" class="auth-avatar-preview" src="/{{ session.user.avatar_path }}" alt="avatar preview">
          {% else %}
          <img id="profileAvatarPreview" class="auth-avatar-preview is-empty" alt="avatar preview">
          {% endif %}
        </div>
        <label for="avatar">อัปโหลดรูปใหม่</label>
        <input id="avatar" type="file" name="avatar" accept="image/*" required>
        <p class="helper">รองรับไฟล์รูปภาพขนาดไม่เกิน 5MB และแนะนำรูปคมชัดเห็นใบหน้าหรือโลโก้ชัดเจน</p>
        <button class="btn primary" type="submit" style="margin-top:10px">อัปเดตรูปโปรไฟล์</button>
      </form>
    </section>

    <section class="card">
      <h3>สรุปการใช้งาน</h3>
      <div class="kpis profile-kpis">
        <div class="kpi">
          <div class="label">จำนวนครั้งที่วิเคราะห์</div>
          <div class="value">{{ total }} ครั้ง</div>
        </div>
        <div class="kpi">
          <div class="label">ความมั่นใจเฉลี่ย</div>
          <div class="value">{{ insights.avg_conf }}%</div>
        </div>
        <div class="kpi">
          <div class="label">ตำแหน่งที่พบมากสุด</div>
          <div class="value">{{ insights.top_part }}</div>
        </div>
        <div class="kpi">
          <div class="label">ใช้งานล่าสุด</div>
          <div class="value">{{ last_time }}</div>
        </div>
        <div class="kpi">
          <div class="label">High</div>
          <div class="value">{{ insights.high_count }}</div>
        </div>
        <div class="kpi">
          <div class="label">Medium</div>
          <div class="value">{{ insights.medium_count }}</div>
        </div>
        <div class="kpi">
          <div class="label">Low</div>
          <div class="value">{{ insights.low_count }}</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>รายการล่าสุด 5 รายการ</h3>
      {% if recent_records %}
      <ul class="recent-list profile-recent">
        {% for r in recent_records %}
        <li>
          <div>
            <div class="recent-main">{{ r.part }} <span class="badge {{ r.result }}">{{ r.result }}</span></div>
            <div class="helper">{{ r.confidence }}% | {{ r.trust }}</div>
          </div>
          <div class="recent-time">{{ r.datetime }}</div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="notice empty">ยังไม่มีข้อมูลวิเคราะห์</div>
      {% endif %}
    </section>
  </main>
</div>
<script>
(function () {
  const scopeSelect = document.getElementById('summary_scope');
  const caseWrap = document.getElementById('casePickerWrap');
  if (scopeSelect && caseWrap) {
    const syncCaseWrap = function () {
      const isCase = scopeSelect.value === 'case';
      caseWrap.style.display = isCase ? '' : 'none';
    };
    syncCaseWrap();
    scopeSelect.addEventListener('change', syncCaseWrap);
  }

  const avatarInput = document.getElementById('avatar');
  const avatarPreview = document.getElementById('profileAvatarPreview');
  if (avatarInput && avatarPreview) {
    avatarInput.addEventListener('change', function (e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        avatarPreview.src = event.target.result;
        avatarPreview.classList.remove('is-empty');
      };
      reader.readAsDataURL(file);
    });
  }
})();
</script>
</body>
</html>


