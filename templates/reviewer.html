<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>เธซเธเนเธฒเธเธนเนเธ•เธฃเธงเธเธ—เธฒเธ | AutoScope AI</title>
<link rel="stylesheet" href="/static/ui.css">
</head>
<body>
<div class="page">
  <aside class="sidebar">
    <div class="brand">AutoScope AI</div>
    <div class="tagline">เธซเธเนเธฒเธเธนเนเธ•เธฃเธงเธเธ—เธฒเธ</div>
    <div class="tagline">เธเธนเนเนเธเน: <span class="mono">{{ username }}</span></div>
    <nav class="nav">
      <a href="/">เธงเธดเน€เธเธฃเธฒเธฐเธซเน</a>
      <a href="/cases">เน€เธเธชเธเธฒเธ</a>
      <a href="/reviewer">เธฃเธตเธงเธดเธงเน€เธเธช</a>
      <a href="/report/latest">เธฃเธฒเธขเธเธฒเธเธฅเนเธฒเธชเธธเธ”</a>
      <a href="/history">เธเธฃเธฐเธงเธฑเธ•เธด</a>
      <a href="/profile">เนเธเธฃเนเธเธฅเน</a>
      {% if is_admin %}
      <a href="/admin">เนเธญเธ”เธกเธดเธ</a>
      {% endif %}
      <a href="/logout">เธญเธญเธเธเธฒเธเธฃเธฐเธเธ</a>
    </nav>
  </aside>

  <main class="main">
    <header class="header">
      <h1>เธซเธเนเธฒเธเธนเนเธ•เธฃเธงเธเธ—เธฒเธ</h1>
      <p>เธเธฑเธ”เธเธฒเธฃเน€เธเธชเธฃเธญเธ•เธฃเธงเธเนเธฅเธฐเธขเธทเธเธขเธฑเธเธเธฅ override เธเธฃเนเธญเธกเธ”เธนเธเธฃเธฐเธงเธฑเธ•เธดเธเธฒเธฃเธฃเธตเธงเธดเธงเธฅเนเธฒเธชเธธเธ”</p>
    </header>

    <section class="card soft">
      <h3>เน€เธเธชเธฃเธญเธ•เธฃเธงเธเธ—เธฒเธ</h3>
      <div class="helper">เธเธดเธงเธเธฑเธเธเธธเธเธฑเธ: {{ pending_cases|length }} เน€เธเธช</div>
      {% if pending_cases %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>เน€เธเนเธฒเธเธญเธเน€เธเธช</th>
              <th>เธซเธฑเธงเธเนเธญ</th>
              <th>เธเธฅเน€เธ”เธดเธก</th>
              <th>เธเธงเธฒเธกเธกเธฑเนเธเนเธ</th>
              <th>เธญเธฑเธเน€เธ”เธ•เธฅเนเธฒเธชเธธเธ”</th>
              <th>เธขเธทเธเธขเธฑเธเธเธฅ</th>
            </tr>
          </thead>
          <tbody>
            {% for c in pending_cases %}
            <tr>
              <td data-label="ID">#{{ c.id|case_code }}</td>
              <td data-label="เน€เธเนเธฒเธเธญเธเน€เธเธช">{{ c.username }}</td>
              <td data-label="เธซเธฑเธงเธเนเธญ">{{ c.title }}</td>
              <td data-label="เธเธฅเน€เธ”เธดเธก">{{ c.predicted_result or "-" }}</td>
              <td data-label="เธเธงเธฒเธกเธกเธฑเนเธเนเธ">{{ c.predicted_confidence if c.predicted_confidence is not none else "-" }}</td>
              <td data-label="เธญเธฑเธเน€เธ”เธ•เธฅเนเธฒเธชเธธเธ”">{{ c.updated_at }}</td>
              <td data-label="เธขเธทเธเธขเธฑเธเธเธฅ">
                <form class="review-form" data-case-id="{{ c.id }}">
                  <select name="final_result" required>
                    <option value="">เน€เธฅเธทเธญเธเธเธฅเธขเธทเธเธขเธฑเธ</option>
                    <option value="low">low</option>
                    <option value="medium">medium</option>
                    <option value="high">high</option>
                  </select>
                  <input name="reviewer_note" type="text" placeholder="เธซเธกเธฒเธขเน€เธซเธ•เธธ reviewer (เนเธกเนเธเธฑเธเธเธฑเธ)">
                  <button class="btn warm" type="submit">เธขเธทเธเธขเธฑเธ</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="notice empty">เนเธกเนเธกเธตเน€เธเธชเธฃเธญเธ•เธฃเธงเธ</div>
      {% endif %}
      <p id="reviewMsg" class="helper"></p>
    </section>

    <section class="card">
      <h3>เธฃเธตเธงเธดเธงเธฅเนเธฒเธชเธธเธ”</h3>
      {% if reviewed_cases %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>เน€เธเนเธฒเธเธญเธเน€เธเธช</th>
              <th>เธเธนเนเธฃเธตเธงเธดเธง</th>
              <th>เธเธฅเน€เธ”เธดเธก</th>
              <th>เธเธฅเธขเธทเธเธขเธฑเธ</th>
              <th>เน€เธงเธฅเธฒเธฃเธตเธงเธดเธง</th>
            </tr>
          </thead>
          <tbody>
            {% for c in reviewed_cases[:40] %}
            <tr>
              <td data-label="ID">#{{ c.id|case_code }}</td>
              <td data-label="เน€เธเนเธฒเธเธญเธเน€เธเธช">{{ c.owner_username }}</td>
              <td data-label="เธเธนเนเธฃเธตเธงเธดเธง">{{ c.reviewer_username or "-" }}</td>
              <td data-label="เธเธฅเน€เธ”เธดเธก">{{ c.predicted_result or "-" }}</td>
              <td data-label="เธเธฅเธขเธทเธเธขเธฑเธ">{{ c.final_result or "-" }}</td>
              <td data-label="เน€เธงเธฅเธฒเธฃเธตเธงเธดเธง">{{ c.reviewed_at or c.updated_at }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="notice empty">เธขเธฑเธเนเธกเนเธกเธตเธเธฃเธฐเธงเธฑเธ•เธดเธเธฒเธฃเธฃเธตเธงเธดเธง</div>
      {% endif %}
    </section>

    <section class="card">
      <h3>Audit เธฅเนเธฒเธชเธธเธ” (Case Review)</h3>
      {% if audit_rows %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>เน€เธงเธฅเธฒ</th>
              <th>เธเธนเนเนเธเน</th>
              <th>Action</th>
              <th>Target</th>
            </tr>
          </thead>
          <tbody>
            {% for a in audit_rows %}
            <tr>
              <td data-label="เน€เธงเธฅเธฒ">{{ a.created_at }}</td>
              <td data-label="เธเธนเนเนเธเน">{{ a.username or "-" }}</td>
              <td data-label="Action">{{ a.action }}</td>
              <td data-label="Target">{{ a.target or "-" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="notice empty">เธขเธฑเธเนเธกเนเธกเธต audit เธเธฒเธฃเธฃเธตเธงเธดเธง</div>
      {% endif %}
    </section>
  </main>
</div>

<script>
(function () {
  const reviewMsg = document.getElementById('reviewMsg');
  document.querySelectorAll('.review-form').forEach(function (reviewForm) {
    reviewForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const caseId = reviewForm.getAttribute('data-case-id');
      const fd = new FormData(reviewForm);
      const res = await fetch('/api/cases/' + caseId + '/review', { method: 'POST', body: fd });
      const data = await res.json();
      if (data.ok) {
        if (reviewMsg) reviewMsg.textContent = 'เธเธฑเธเธ—เธถเธเธเธฅเธฃเธตเธงเธดเธงเน€เธเธช #' + caseId + ' เนเธฅเนเธง';
        setTimeout(function () { location.reload(); }, 700);
      } else {
        if (reviewMsg) reviewMsg.textContent = 'เธฃเธตเธงเธดเธงเนเธกเนเธชเธณเน€เธฃเนเธ: ' + (data.error || 'unknown');
      }
    });
  });
})();
</script>
</body>
</html>

